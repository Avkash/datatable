# DO NOT CHANGE the "init" and "install" sections below
image: Visual Studio 2017
# Download script file from GitHub
build:
  verbosity: normal

init:
  ps: |
        $ErrorActionPreference = "Stop"
        Invoke-WebRequest http://raw.github.com/krlmlr/r-appveyor/master/scripts/appveyor-tool.ps1 -OutFile "..\appveyor-tool.ps1"
        Import-Module '..\appveyor-tool.ps1'
install:
  - choco install mingw
# - choco install vcredist2015
  - choco install llvm
  - choco install make -y
#- set LLVM_CONFIG=/Program Files/LLVM/bin
# - llvm-config --version
#- llvm-config --host-target
  - "%PYTHON%/Scripts/pip.exe install setuptools"
  - "%PYTHON%/Scripts/pip.exe install python-dateutil"
  - "%PYTHON%/Scripts/pip.exe install numpy"
  - "%PYTHON%/Scripts/pip.exe install colorama"
  - "%PYTHON%/Scripts/pip.exe install typesentry"
  - "%PYTHON%/Scripts/pip.exe install blessed"
  - "%PYTHON%/Scripts/pip.exe install llvmlite"
  - "%PYTHON%/Scripts/pip.exe install pandas"
  - "%PYTHON%/Scripts/pip.exe install pytest"
  - "%PYTHON%/Scripts/pip.exe install virtualenv"
  - "%PYTHON%/Scripts/pip.exe install wheel"
  #ps: Bootstrap

skip_branch_with_pr: true

environment:
  global:
    GCC_PATH: mingw_64
  LLVM6: C:\\Program Files\\LLVM
  PATH: "%LLVM6%/bin;%PATH%"
  APPVEYOR_SAVE_CACHE_ON_ERROR: true

  matrix:
    - platform: x64
      PYTHON: "C:\\Python35"
      PYTHON_VERSION: "3.5"
      PYTHON_ARCH: "64"
      DISTRIBUTIONS: "sdist bdist_wheel"

    - platform: x64
      PYTHON: "C:\\Python36"
      PYTHON_VERSION: "3.6"
      PYTHON_ARCH: "64"
      DISTRIBUTIONS: "sdist bdist_wheel"

before_build:
  - "ECHO %PYTHON% %PYTHON_VERSION% %PYTHON_ARCH%"
  - "ECHO %LLVM6%"
  #- copy "C:\tools\mingw64\x86_64-w64-mingw32\lib\libgomp-1.dll" "C:\Program Files\LLVM\lib\"

cache:
  - /ProgramData/chocolatey/bin -> appveyor.yml
  - /ProgramData/chocolatey/lib -> appveyor.yml
  - '%LOCALAPPDATA%/pip/Cache'

test_script:
  # Apparently, 'dir' does not understand forward-slash paths...
  # - dir C:\ProgramData\chocolatey\lib\make\tools\bin\
  # - dir C:\ProgramData\
  # - dir "C:\Program Files\"
  #- DIR /S "C:\tools\mingw64"
  # - dir %PYTHON%\
  # - /ProgramData/chocolatey/lib/make/tools/bin/make.exe test_install PYTHON=%PYTHON%/python.exe
  - copy "C:\tools\mingw64\x86_64-w64-mingw32\lib\libgomp-1.dll" "C:\Program Files\LLVM\lib\"
  - "%PYTHON%/python.exe -m pip install .[testing] --no-cache-dir"
  - /ProgramData/chocolatey/lib/make/tools/bin/make.exe PYTHON=%PYTHON%/python.exe

artifacts:
  - path: dist/*
